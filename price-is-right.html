<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<div class="section-container" style="padding-bottom: 5px; margin-bottom: 5px; margin-top: 5px;">
    <div class="section-head">Spin the Wheel</div>
    <button id="spinButton">Spin</button>
    <div class="section-body">
        <div class="flex-row">
            <div class="framed-element-container" style="height: 235px; position: relative;">
                <div class="wheels">
                    <div class="wheel">
                        <div data-index="0">
                            <div class="icon icon-indicator icon-medium icon-border icon-border-medium rarity-color-1 no-hover" style="bottom: 4%;">
                                <img src="https://i.ibb.co/B6vKL0V/floof-give-bone-128-b.png">
                                <span class="icon-number bottom-right rarity-color-1">0</span>
                            </div>
                        </div>
                        <div data-index="1">
                            <div class="icon icon-indicator icon-medium icon-border icon-border-medium rarity-color-2 no-hover" style="bottom: 4%;">
                                <img src="https://i.ibb.co/vPsjc6F/floof-concentrate-128-b.png">
                                <span class="icon-number bottom-right rarity-color-2">1</span>
                            </div>
                        </div>
                        <div data-index="2">
                            <div class="icon icon-indicator icon-medium icon-border icon-border-medium rarity-color-3 no-hover" style="bottom: 4%;">
                                <img src="https://i.ibb.co/vqR6TW1/floof-bark-128.png">
                                <span class="icon-number bottom-right rarity-color-3">2</span>
                            </div>
                        </div>
                        <div data-index="3">
                            <div class="icon icon-indicator icon-medium icon-border icon-border-medium rarity-color-4 no-hover" style="bottom: 4%;">
                                <img src="https://i.ibb.co/hL5qBwc/floof-wave-hand-128.png">
                                <span class="icon-number bottom-right rarity-color-4">3</span>
                            </div>
                        </div>
                        <div data-index="4">
                            <div class="icon icon-indicator icon-medium icon-border icon-border-medium rarity-color-5 no-hover" style="bottom: 4%;">
                                <img src="https://i.ibb.co/B6vKL0V/floof-give-bone-128-b.png">
                                <span class="icon-number bottom-right rarity-color-5">4</span>
                            </div>
                        </div>
                        <div data-index="5">
                            <div class="icon icon-indicator icon-medium icon-border icon-border-medium rarity-color-6 no-hover" style="bottom: 4%;">
                                <img src="https://i.ibb.co/vPsjc6F/floof-concentrate-128-b.png">
                                <span class="icon-number bottom-right rarity-color-6">5</span>
                            </div>
                        </div>
                        <div data-index="6">
                            <div class="icon icon-indicator icon-medium icon-border icon-border-medium rarity-color-7 no-hover" style="bottom: 4%;">
                                <img src="https://i.ibb.co/vqR6TW1/floof-bark-128.png">
                                <span class="icon-number bottom-right rarity-color-7">6</span>
                            </div>
                        </div>
                        <div data-index="7">
                            <div class="icon icon-indicator icon-medium icon-border icon-border-medium rarity-color-8 no-hover" style="bottom: 4%;">
                                <img src="https://i.ibb.co/hL5qBwc/floof-wave-hand-128.png">
                                <span class="icon-number bottom-right rarity-color-8">7</span>
                            </div>
                        </div>
                        <div data-index="8">
                            <div class="icon icon-indicator icon-medium icon-border icon-border-medium rarity-color-9 no-hover" style="bottom: 4%;">
                                <img src="https://i.ibb.co/B6vKL0V/floof-give-bone-128-b.png">
                                <span class="icon-number bottom-right rarity-color-9">8</span>
                            </div>
                        </div>
                        <div data-index="9">
                            <div class="icon icon-indicator icon-medium icon-border icon-border-medium rarity-color-10 no-hover" style="bottom: 4%;">
                                <img src="https://i.ibb.co/vPsjc6F/floof-concentrate-128-b.png">
                                <span class="icon-number bottom-right rarity-color-10">9</span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Marker -->
                <div class="marker"></div>
            </div>
        </div>
    </div>
</div>




<style>
    :root {
        --scaling-factor: 0.792;
    }
    
    .wheels {
        box-sizing: border-box;
        position: relative;
        left: 50%;
        top: 65%;
        padding: 0;
        text-align: center;
        width: 50%;
        height: calc(10rem * var(--scaling-factor)); /* Adjust height using the scaling factor */
        user-select: none;
        transform: translate(-7.1%, -50%);
    }
    
    .wheels .wheel {
        box-sizing: border-box;
        position: relative;
        padding: 0;
        margin: 0;
        height: 100%;
        width: 14.2%; /* Adjust based on $num-wheels */
        transform-style: preserve-3d;
        transform-origin: 100% 25%;
    }
    
    .wheels .wheel > div {
        box-sizing: border-box;
        position: absolute;
        width: 100%;
        height: 51%; /* Adjust segment height */
        line-height: calc(5rem * var(--scaling-factor)); /* Adjust line-height */
        text-align: center;
        z-index: 0;
        background: #C43;
        border: solid 2px #333;
        outline: 1px solid transparent;
        backface-visibility: hidden;
    }
    
    .wheels .wheel > div:nth-of-type(1) {
        transform: perspective(500px) rotate3d(1, 0, 0, 0deg) translate3d(0, 0, 122px);
        background: hsla(0deg, 100%, 75%, 0.8);
    }
    
    .wheels .wheel > div:nth-of-type(2) {
        transform: perspective(500px) rotate3d(1, 0, 0, 36deg) translate3d(0, 0, 122px);
        background: hsla(36deg, 100%, 75%, 0.8);
    }
    
    .wheels .wheel > div:nth-of-type(3) {
        transform: perspective(500px) rotate3d(1, 0, 0, 72deg) translate3d(0, 0, 122px);
        background: hsla(72deg, 100%, 75%, 0.8);
    }
    
    .wheels .wheel > div:nth-of-type(4) {
        transform: perspective(500px) rotate3d(1, 0, 0, 108deg) translate3d(0, 0, 122px);
        background: hsla(108deg, 100%, 75%, 0.8);
    }
    
    .wheels .wheel > div:nth-of-type(5) {
        transform: perspective(500px) rotate3d(1, 0, 0, 144deg) translate3d(0, 0, 122px);
        background: hsla(144deg, 100%, 75%, 0.8);
    }
    
    .wheels .wheel > div:nth-of-type(6) {
        transform: perspective(500px) rotate3d(1, 0, 0, 180deg) translate3d(0, 0, 122px);
        background: hsla(180deg, 100%, 75%, 0.8);
    }
    
    .wheels .wheel > div:nth-of-type(7) {
        transform: perspective(500px) rotate3d(1, 0, 0, 216deg) translate3d(0, 0, 122px);
        background: hsla(216deg, 100%, 75%, 0.8);
    }
    
    .wheels .wheel > div:nth-of-type(8) {
        transform: perspective(500px) rotate3d(1, 0, 0, 252deg) translate3d(0, 0, 122px);
        background: hsla(252deg, 100%, 75%, 0.8);
    }
    
    .wheels .wheel > div:nth-of-type(9) {
        transform: perspective(500px) rotate3d(1, 0, 0, 288deg) translate3d(0, 0, 122px);
        background: hsla(288deg, 100%, 75%, 0.8);
    }
    
    .wheels .wheel > div:nth-of-type(10) {
        transform: perspective(500px) rotate3d(1, 0, 0, 324deg) translate3d(0, 0, 122px);
        background: hsla(324deg, 100%, 75%, 0.8);
    }

    .marker {
        position: absolute;
        top: 50%;
        left: 45.2%;
        width: 0;
        height: 0;
        border-left: 20px solid red; /* Adjust size and color */
        border-top: 10px solid transparent;
        border-bottom: 10px solid transparent;
        transform: translate(-50%, -50%);
        z-index: 10;
    }
    
    </style>
    

    <script>
(function ($) {
    const scalingFactor = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--scaling-factor'));

    function applyTransforms(coords) {
        $('.wheel > div').each(function (i) {
            var angle = -(coords.y / 2) + (360 / 10) * i;
            $(this).css('transform', `perspective(${500 * scalingFactor}px) rotate3d(1, 0, 0, ${angle}deg) translate3d(0, 0, ${122 * scalingFactor}px)`);
        });
    }

    function calculateSegment(angle) {
        const segmentCount = 10;
        const segmentAngle = 360 / segmentCount;
        const offset = segmentAngle / 2; // Adjust this value to fine-tune alignment
        let adjustedAngle = (angle + offset) % 360;
        if (adjustedAngle < 0) {
            adjustedAngle += 360;
        }
        return Math.floor(adjustedAngle / segmentAngle);
    }

    var current_coords = { x: 0, y: 0 };
    var velocity = { x: 0, y: 0 };
    var inertia_time = null;
    var isSpinning = false;

    $.fn.momentus = function (cfg) {
        var now = Date.now || function () { return (new Date()).valueOf() },
            last_time = now(),

            // Configuration
            mass = cfg.mass || 1000,
            u = cfg.u || 4,
            wheel_ratio = cfg.wheelRatio || 1000,
            on_change = cfg.onChange || function () { },
            frame_rate = cfg.frameRate || 60;

        function calculateVelocity(delta_time) {
            var vel_y = velocity.y - (u * (velocity.y / mass) * delta_time);
            return { x: 0, y: vel_y };
        }

        function inertia() {
            if (!isSpinning) {
                return;
            }

            velocity.x = !isNaN(velocity.x) ? velocity.x : 0;
            velocity.y = !isNaN(velocity.y) ? velocity.y : 0;

            if (!inertia_time) {
                inertia_time = now();
            } else if (velocity.y != 0) {
                var time = now(),
                    delta_time = time - inertia_time,
                    new_velocity = calculateVelocity(delta_time);

                velocity.y = new_velocity.y;

                var delta_y = velocity.y * delta_time;
                current_coords.y += delta_y;
                inertia_time = time;
                on_change(current_coords, velocity);

                // If velocity is very low, consider the wheel stopped
                if (Math.abs(velocity.y) < 0.01) {
                    isSpinning = false;
                    const finalAngle = current_coords.y / 2;
                    const segment = calculateSegment(finalAngle);
                    console.log('Final Segment:', segment);

                    // Log the corresponding div
                    const selectedDiv = $(`.wheel > div[data-index="${segment}"]`);
                    const imgSrc = selectedDiv.find('img').attr('src');
                    const number = selectedDiv.find('.icon-number').text();
                    console.log(`Selected Div Index: ${segment}, Image: ${imgSrc}, Number: ${number}`);

                    $('#spinButton').prop('disabled', false); // Enable the spin button
                    return; // Exit the loop when the wheel stops
                }
            }

            if (isSpinning) {
                if (window.requestAnimationFrame) {
                    requestAnimationFrame(inertia);
                } else {
                    setTimeout(inertia, 1000 / frame_rate);
                }
            }
        }

        return {
            startSpin: function () {
                isSpinning = true;
                inertia_time = now();
                inertia();
            }
        };
    }

    $(document).ready(function () {
        applyTransforms(current_coords);
        const momentusInstance = $('.wheel').momentus({
            u: 1,
            mass: 1000,
            wheelRatio: -1000,
            onChange: function (coords, velocity) {
                applyTransforms(coords);
            }
        });

        $('#spinButton').on('click', function () {
            if (isSpinning) return;
            isSpinning = true;
            $('#spinButton').prop('disabled', true); // Disable the spin button
            let initialVelocity = Math.random() * (12 - 10) + 2; // Updated initial velocity function
            velocity.y = initialVelocity;
            inertia_time = Date.now();
            momentusInstance.startSpin(); // Call the inertia function correctly
        });
    });

})(jQuery);
        </script>
        